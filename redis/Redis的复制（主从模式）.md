# Redis的复制（主从模式）

## 一、主从模式

假设有两台Redis服务器，127.0.0.1:6379和127.0.0.1:6380，我们希望将其中一台作为主服务器，另一台作为从服务器，可以通过SLAVEOF命令或者slaveof选项来实现，通过客户端：127.0.0.1:6380 >  SLAVEOF  127.0.0.1:6379，实现两台服务器的主从复制。当数据同步之后，加入在127.0.0.1:6379发送```set key1 val1```后，我们除了能够通过该服务器获取到key1的值，也能够在127.0.0.1:6380通过```get key1```获取到key1的值，而当在主服务器将该键删除后，同样在从服务器中也将查询不到该键。这就是主从模式的特点，通过主服务器与从服务器之间的数据同步，我们可以在多台服务器上访问到主服务器的数据。

## 二、优缺点 

特点：

* 引入主从模式之后，一个明显的好处就是，我们可以在多台服务器上访问到主服务器上的值。这对于公用缓存数据的访问是非常方便的；
* 并且也降低了主服务器读数据的压力，将压力转交到从服务器。



缺点：

* 写数据的压力没得到缓解，由于写数据只能通过主服务器，所以对于写入数据频繁的系统，写数据的压力还是比较大；
* 不具有高可用性。只有一台主服务器，当主服务器发生故障时，将无法进行数据的写入。

## 三、复制的实现

总的来说，可以认为复制是通过RDB + AOF来实现的。

具体步骤：

* 从服务器向主服务器发送SYNC命令请求数据同步；
* 主服务器在收到从服务器的同步请求后，执行BGSAVE命令，在后台生成一个RDB文件，用于发送给从服务器进行数据同步，同时，主服务器还会在一个缓冲区中记录下在生成RDB文件的这段时间内接收到的写命令；
* 在主服务器BGSAVE命令执行完毕后，就会将RDB文件发送给从服务器，从服务器接受到RDB文件后进行数据载入，更新数据；
* 随后，主服务器会把这段时间保存在缓冲区里的写命令发送给从服务器，从服务器接受到后执行命令，从而完成数据的同步操作。

## 四、旧版复制的缺陷

旧版复制在初始化从服务器上效率没有问题，但在从服务器因为断电与主服务器连接不上，数据不同步后，需要重新执行同步时，就会有效率上的缺陷。虽然最终能够保证数据的一致性，但缺耗费了很多资源。这是因为，从服务器是由于临时的网络问题才导致与主服务器的数据不同步。而之前的数据是保持一致的，当连接恢复后，旧版复制仍然会执行所有数据的同步操作，这对于连接前同步的数据，是没有必要的重复操作，而这些重复操作却会占用系统的资源，因为在同步过程中，从服务器是不能被客户端访问的，同时，重复数据会造成RDB文件大很多，而消耗网络带宽。

比较合理的方式是，只记录连接中断后执行的写命令，在连接恢复后，主服务器只需要将这段时间的写命令发送给从服务器即可。这就是PSYNC.