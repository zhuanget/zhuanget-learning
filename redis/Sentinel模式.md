# Redis的Sentinel模式（哨兵模式）

## 一、概念

Sentinel系统由Sentinel实例组成，Sentinel实例其实就是Redis主服务器的客户端。Sentinel系统负责监视主服务器及其属下的从服务器，它会定时地查看服务器的健康状态，当主服务器下线后，它会从它属下的从服务器中推选出一个优良的从服务器作为新的主服务器，以便继续为客户端提供服务，这样就可避免主从模式下当主服务器出现问题后造成系统无法使用的情况，提高系统的高可用性。

## 二、检测主观下线和客观下线

Sentinel每隔一秒会向主服务器发送PING命令，如果长时间没收到回复，就会判定为主观下线。在检测到主服务器主观下线后，Sentinel会向其他监视主服务器的Sentinel询问主服务器的状态，通过发送SENTINEL is-master-down-by-addr命令获取，如果其他Sentinel回复主服务器主观下线的次数超过一定数量后（可通过配置参数quorum的值调整），Sentinel就会将主服务器判定为客观下线，进而会从该主服务器的从服务器中推选出新的主服务器来，并完成故障迁移。

## 三、选举领头Sentinel

任何一个Sentinel都有机会成为领头Sentinel。通过拼条件选出来。源Sentinel向目标Sentinel发送想成为领头Sentinel的命令后，按照先到先得的原则，如果目标Sentinel还没有人给他发，他就会把这个机会给源Sentinel，给他回复成功的消息，而如果已经把这个机会给到其他Sentinel了，那么目标Sentinel就会向源Sentinel回复失败的消息。一轮之后，通过统计各个Sentinel获取到成功的消息的个数，如果超过半数，就会将这个Sentinel推举为新的领头Sentinel。而如果在这段限定时间内，没有人能够成为领头Sentinel，就会开启新一轮的选举，直到选出为止。

个人认为这个就是拼网速等条件了，条件好的发送命令的速度快，就能抢先得到回应，超过半数，说明该Sentinel所处环境是最优的，选它做领头准没错，这样的道理。

## 四、故障转移

故障转移分三个步骤：

* 由领头Sentinel在主服务器属下的从服务器中，选出一个作为新的主服务器，并向它发送SLAVEOF NO ONE，取消其从服务器状态；
* 分别对其他从服务器向该新的主服务器发送SLAVEOF命令，让其他从服务器成为该主服务器的从服务器；
* 将原来的主服务器改为从属于新的主服务器，这样当它重新上线后，就会成为新主服务器的从服务器。

推选新的主服务器的原则：

* 下线的不要；
* 没回复INFO的不要；
* 连接超时的不要；
* 按照优先级排序；
* 按照偏移量倒序（偏移量越大说明它跟主服务器的数据差距越小）；
* RUN ID排序；

